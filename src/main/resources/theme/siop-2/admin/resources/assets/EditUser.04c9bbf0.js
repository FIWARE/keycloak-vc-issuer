import{b8 as We,b9 as it,ba as dt,bd as Ve,bc as lt,bb as ct,d as ut,be as je,c as mt,aj as pt,i as ht,d6 as ft,d7 as gt,d8 as bt,d9 as yt,da as Ct,db as wt,u as E,az as K,aA as J,r as y,j as e,P as oe,cv as Ue,ck as vt,ch as It,aX as V,ad as ne,h as I,F as $,bE as z,b7 as Xe,aw as _,aB as kt,aZ as xe,q as N,dc as Tt,dd as Pt,am as xt,ap as St,al as Lt,ao as Fe,K as Je,G as Dt,n as He,R as At,aE as Qe,l as Se,g as Rt,T as Ie,bD as Et,b3 as Ft,cx as Nt,L as qe,ax as Ut,de as Mt,c2 as Kt}from"./index.2ecf13ca.js";import{u as ce,C as Me,a as Ye,b as Bt,F as Ze}from"./index.esm.68aaf060.js";import{u as ie,C as et}from"./ConfirmDialog.b43fd344.js";import{R as Gt,u as Ot}from"./RoutableTabs.ce00f00c.js";import{V as Vt}from"./ViewHeader.67577dd4.js";import{u as jt,U as Ht}from"./UserProfileContext.1a5ea02c.js";import{u as Ke}from"./useParams.921239aa.js";import{A as qt}from"./AttributeForm.417b4170.js";import{L as Be}from"./ListEmptyState.94d606ed.js";import{K as Pe,P as zt,T as _t,m as $t,n as Wt}from"./KeycloakDataTable.5c9a6c7c.js";import{u as Xt}from"./useFormatDate.742c67f0.js";import{i as Jt,ag as O,L as Qt,e as M,T as tt,a as st,b as he,c as Y,d as rt,z as Ee}from"./Td.ff2a9f66.js";import{C as Yt,S as Zt}from"./SessionsTable.67f1e7d6.js";import{C as es,c as ts,S as ss,b as rs,a as as}from"./Select.5d6f6214.js";import{H as Le,P as ns}from"./HelpItem.49be9c4e.js";import{P as ze}from"./PasswordInput.4caf2dff.js";import{u as Ne}from"./useToggle.97c716af.js";import{F as De,a as te}from"./FormGroup.24d2e56a.js";import{T as os}from"./TimeSelector.ba2ee1d5.js";import{a as Ge,M as at}from"./Modal.2c72168d.js";import{K as Te}from"./KeycloakTextInput.97e36976.js";import{u as is}from"./useLocaleSort.377bcdf5.js";import{F as ds,U as ls,i as cs,u as us}from"./UserForm.74fa37b0.js";import{G as ms,a as ps}from"./GroupPickerDialog.38947607.js";import{C as hs}from"./Checkbox.56efba4a.js";import{Q as fs}from"./question-circle-icon.cdbe36b5.js";import{F as _e}from"./FormPanel.3fe898ae.js";import{c as fe}from"./capitalize.ba62b65f.js";import{T as ke}from"./Text.441b2f8e.js";import{R as gs}from"./AddRoleMappingModal.c7175fba.js";/* empty css                     */import{T as re,a as ae}from"./Tabs.3b19dcd9.js";import"./FormAccess.7ed5d8eb.js";import"./copy-icon.06155c15.js";import"./GridItem.a22d8cac.js";import"./KeyValueInput.8d334a75.js";import"./FlexItem.2ee8dfc9.js";import"./minus-circle-icon.e9e185f2.js";import"./ActionListItem.c90af00f.js";import"./plus-circle-icon.f1969120.js";import"./TableToolbar.f167c244.js";import"./EmptyStateSecondaryActions.3ed74a6a.js";import"./EmptyStateBody.25bf6e38.js";import"./star-icon.648ddb2a.js";import"./check.51c67984.js";import"./grip-vertical-icon.6efe1939.js";import"./ListItem.e829200f.js";import"./useIsFeatureEnabled.d8b1daf2.js";import"./ScrollForm.6573b3d3.js";import"./DataListItemRow.7402b99a.js";import"./data-list.f7ff2ea7.js";import"./CardHeader.2467be54.js";import"./Card.3271e4cd.js";import"./CardTitle.ab8f9378.js";import"./CardBody.8e0a3a4b.js";import"./resource.09062762.js";import"./joinPath.69b856b1.js";import"./filter-icon.f568e30b.js";import"./plus-icon.a1ecd1af.js";import"./MenuList.32e086d6.js";var bs=Math.min;function ys(t,s,n){for(var i=n?lt:ct,a=t[0].length,p=t.length,c=p,d=Array(p),l=1/0,m=[];c--;){var f=t[c];c&&s&&(f=We(f,it(s))),l=bs(f.length,l),d[c]=!n&&(s||a>=120&&f.length>=120)?new dt(c&&f):void 0}f=t[0];var o=-1,u=d[0];e:for(;++o<a&&m.length<l;){var b=f[o],g=s?s(b):b;if(b=n||b!==0?b:0,!(u?Ve(u,g):i(m,g,n))){for(c=p;--c;){var R=d[c];if(!(R?Ve(R,g):i(t[c],g,n)))continue e}u&&u.push(g),m.push(b)}}return m}function Cs(t){return Jt(t)?t:[]}var ws=ut(function(t){var s=je(t),n=We(t,Cs);return s===je(n)?s=void 0:n.pop(),n.length&&n[0]===t[0]?ys(n,mt(s)):[]});const vs=ws;var Is="[object Map]",ks="[object Set]",Ts=Object.prototype,Ps=Ts.hasOwnProperty;function $e(t){if(t==null)return!0;if(pt(t)&&(ht(t)||typeof t=="string"||typeof t.splice=="function"||ft(t)||gt(t)||bt(t)))return!t.length;var s=yt(t);if(s==Is||s==ks)return!t.size;if(Ct(t))return!wt(t).length;for(var n in t)if(Ps.call(t,n))return!1;return!0}const xs=({user:t})=>{const{t:s}=E("users"),{adminClient:n}=K(),{addAlert:i,addError:a}=J(),[p,c]=y.exports.useState(t),d=ce({mode:"onChange"}),{config:l}=jt(),m=()=>vt(p.attributes).filter(o=>!l?.attributes?.some(u=>u.name===o.key));y.exports.useEffect(()=>{d.setValue("attributes",m())},[p]);const f=async o=>{try{const u=Object.assign({},p.attributes||{},It(o.attributes));await n.users.update({id:p.id},{...p,attributes:u}),c({...p,attributes:u}),i(s("userSaved"),V.success)}catch(u){a("groups:groupUpdateError",u)}};return e(oe,{variant:Ue.light,children:e(qt,{form:d,save:f,fineGrainedAccess:p.access?.manage,reset:()=>d.reset({attributes:m()})})})},Ss=()=>{const[t,s]=y.exports.useState(),{t:n}=E("roles"),{addAlert:i,addError:a}=J(),p=Xt(),[c,d]=y.exports.useState(0),{adminClient:l}=K(),{id:m}=Ke(),f=k=>Xe(k,B=>B.clientId?.toUpperCase()),o=()=>d(new Date().getTime()),u=async()=>{const k=await l.users.listConsents({id:m});return f(k)},b=({grantedClientScopes:k})=>e(es,{className:"kc-consents-chip-group",children:k.map(B=>e(ts,{isReadOnly:!0,className:"kc-consents-chip",id:"consents-chip-text",children:B},B))}),[g,R]=ie({titleKey:"users:revokeClientScopesTitle",messageKey:n("users:revokeClientScopes",{clientId:t?.clientId}),continueButtonLabel:"common:revoke",continueButtonVariant:ne.danger,onConfirm:async()=>{try{await l.users.revokeConsent({id:m,clientId:t.clientId}),o(),i(n("deleteGrantsSuccess"),V.success)}catch(k){a("roles:deleteGrantsError",k)}}});return I($,{children:[e(R,{}),e(Pe,{loader:u,ariaLabelKey:"roles:roleList",searchPlaceholderKey:" ",columns:[{name:"clientId",displayKey:"clients:Client",cellFormatters:[z()],transforms:[O(20)]},{name:"grantedClientScopes",displayKey:"client-scopes:grantedClientScopes",cellFormatters:[z()],cellRenderer:b,transforms:[O(30)]},{name:"createDate",displayKey:"clients:created",transforms:[O(20)],cellRenderer:({createDate:k})=>k?p(new Date(k)):"\u2014"},{name:"lastUpdatedDate",displayKey:"clients:lastUpdated",transforms:[O(10)],cellRenderer:({lastUpdatedDate:k})=>k?p(new Date(k)):"\u2014"}],actions:[{title:n("users:revoke"),onRowClick:k=>{s(k),g()}}],emptyState:e(Be,{hasIcon:!0,icon:Yt,message:n("users:noConsents"),instructions:n("users:noConsentsText")})},c)]})},Ls={password:"",passwordConfirmation:"",temporaryPassword:!0},Ds=({user:t,isResetPassword:s,refresh:n,onClose:i})=>{const{t:a}=E("users"),{register:p,control:c,formState:{isValid:d,errors:l},watch:m,handleSubmit:f}=ce({defaultValues:Ls,mode:"onChange"}),[o,u]=Ne(!0),b=m("password",""),{adminClient:g}=K(),{addAlert:R,addError:k}=J(),[B,Z]=ie({titleKey:s?"users:resetPasswordConfirm":"users:setPasswordConfirm",messageKey:s?a("resetPasswordConfirmText",{username:t.username}):a("setPasswordConfirmText",{username:t.username}),continueButtonLabel:s?"users:resetPassword":"users:savePassword",continueButtonVariant:ne.danger,onConfirm:()=>f(ee)()}),ee=async({password:L,temporaryPassword:W})=>{try{await g.users.resetPassword({id:t.id,credential:{temporary:W,type:"password",value:L}});const A=(await g.users.getCredentials({id:t.id})).find(G=>G.type==="password");A&&await g.users.updateCredentialLabel({id:t.id,credentialId:A.id},a("defaultPasswordLabel")),R(a(s?"resetCredentialsSuccess":"savePasswordSuccess"),V.success),n()}catch(D){k(s?"users:resetPasswordError":"users:savePasswordError",D)}i()};return I($,{children:[e(Z,{}),e(et,{titleKey:s?a("resetPasswordFor",{username:t.username}):a("setPasswordFor",{username:t.username}),open:o,onCancel:i,toggleDialog:u,onConfirm:B,confirmButtonDisabled:!d,continueButtonLabel:"common:save",children:I(De,{id:"userCredentials-form",isHorizontal:!0,className:"keycloak__user-credentials__reset-form",children:[e(te,{name:"password",label:a("password"),fieldId:"password",helperTextInvalid:a("common:required"),validated:l.password?_.error:_.default,isRequired:!0,children:e(ze,{"data-testid":"passwordField",id:"password",...p("password",{required:!0})})}),e(te,{name:"passwordConfirmation",label:a(s?"resetPasswordConfirmation":"passwordConfirmation"),fieldId:"passwordConfirmation",helperTextInvalid:l.passwordConfirmation?.message,validated:l.passwordConfirmation?_.error:_.default,isRequired:!0,children:e(ze,{"data-testid":"passwordConfirmationField",id:"passwordConfirmation",...p("passwordConfirmation",{required:!0,validate:L=>L===b||a("confirmPasswordDoesNotMatch").toString()})})}),e(te,{label:a("common:temporaryPassword"),labelIcon:e(Le,{helpText:"temporaryPasswordHelpText",fieldLabelId:"temporaryPassword"}),fieldId:"kc-temporaryPassword",children:e(Me,{name:"temporaryPassword",defaultValue:!0,control:c,render:({field:L})=>e(kt,{className:"kc-temporaryPassword",onChange:L.onChange,isChecked:L.value,label:a("common:on"),labelOff:a("common:off"),"aria-label":a("common:temporaryPassword")})})})]})})]})},As=()=>{const{t}=E("users"),{adminClient:s}=K(),{control:n}=Ye(),[i,a]=y.exports.useState(!1),[p,c]=y.exports.useState([]);return xe(()=>s.authenticationManagement.getRequiredActions(),d=>{c(d)},[]),e(te,{label:t("resetActions"),labelIcon:e(Le,{helpText:"clients-help:resetActions",fieldLabelId:"resetActions"}),fieldId:"actions",children:e(Me,{name:"actions",defaultValue:[],control:n,render:({field:d})=>e(ss,{toggleId:"actions",variant:rs.typeaheadMulti,chipGroupProps:{numChips:3},menuAppendTo:"parent",onToggle:l=>a(l),isOpen:i,selections:d.value,onSelect:(l,m)=>d.onChange(d.value.find(f=>f===m)?d.value.filter(f=>f!==m):[...d.value,m]),onClear:l=>{l.stopPropagation(),d.onChange([])},typeAheadAriaLabel:t("resetActions"),children:p.map(({alias:l,name:m})=>e(as,{value:l,"data-testid":`${l}-option`,children:m},l))})})})},Rs=()=>{const{t}=E("users"),{control:s}=Ye();return e(te,{fieldId:"lifespan",label:t("lifespan"),isStack:!0,labelIcon:e(Le,{helpText:"clients-help:lifespan",fieldLabelId:"lifespan"}),children:e(Me,{name:"lifespan",defaultValue:nt.lifespan,control:s,render:({field:n})=>e(os,{value:n.value,units:["minute","hour","day"],onChange:n.onChange,menuAppendTo:"parent"})})})},nt={actions:[],lifespan:43200},Es=({userId:t,onClose:s})=>{const{t:n}=E("users"),i=ce({defaultValues:nt}),{handleSubmit:a,control:p}=i,c=Bt({control:p,name:"actions"}),d=!$e(c),{adminClient:l}=K(),{addAlert:m,addError:f}=J(),o=async({actions:u,lifespan:b})=>{if(!$e(u))try{await l.users.executeActionsEmail({id:t,actions:u,lifespan:b}),m(n("credentialResetEmailSuccess"),V.success),s()}catch(g){f("users:credentialResetEmailError",g)}};return e(et,{variant:Ge.medium,titleKey:"users:credentialReset",open:!0,onCancel:s,toggleDialog:s,continueButtonLabel:"users:credentialResetConfirm",onConfirm:()=>{a(o)()},confirmButtonDisabled:!d,children:e(De,{id:"userCredentialsReset-form",isHorizontal:!0,"data-testid":"credential-reset-modal",children:I(Ze,{...i,children:[e(As,{}),e(Rs,{})]})})})},Fs=({userId:t,credential:s,isEditable:n,toggle:i})=>{const{t:a}=E("users"),{register:p,handleSubmit:c}=ce(),{adminClient:d}=K(),{addAlert:l,addError:m}=J();return e(De,{isHorizontal:!0,className:"kc-form-userLabel",onSubmit:c(async o=>{try{await d.users.updateCredentialLabel({id:t,credentialId:s.id},o.userLabel||""),l(a("updateCredentialUserLabelSuccess"),V.success),i()}catch(u){m("users:updateCredentialUserLabelError",u)}}),children:e(te,{fieldId:"kc-userLabel",className:"kc-userLabel-row",children:e("div",{className:"kc-form-group-userLabel",children:n?I($,{children:[e(Te,{"data-testid":"userLabelFld",defaultValue:s.userLabel,className:"kc-userLabel","aria-label":a("userLabel"),...p("userLabel")}),I("div",{className:"kc-userLabel-actionBtns",children:[e(N,{"data-testid":"editUserLabelAcceptBtn",variant:"link",className:"kc-editUserLabelAcceptBtn",type:"submit",icon:e(Tt,{})}),e(N,{"data-testid":"editUserLabelCancelBtn",variant:"link",className:"kc-editUserLabel-cancelBtn",onClick:i,icon:e(Pt,{})})]})]}):I($,{children:[s.userLabel,e(N,{"aria-label":a("editUserLabel"),variant:"link",className:"kc-editUserLabel-btn",onClick:i,"data-testid":"editUserLabelBtn",icon:e(zt,{})})]})})})})},Ns=({credentialData:t,onClose:s})=>{const{t:n}=E("users");return e(at,{variant:Ge.medium,title:n("passwordDataTitle"),"data-testid":"passwordDataDialog",isOpen:!0,onClose:s,children:I(_t,{"aria-label":n("passwordDataTitle"),"data-testid":"password-data-dialog",variant:Qt.compact,cells:[n("showPasswordDataName"),n("showPasswordDataValue")],rows:t,children:[e($t,{}),e(Wt,{})]})})},Us=({credential:t,resetPassword:s,toggleDelete:n,children:i})=>{const{t:a}=E("users"),[p,c]=Ne(),[d,l]=Ne(),m=is(),f=y.exports.useMemo(()=>{if(!t.credentialData)return[];const o=JSON.parse(t.credentialData);return m(Object.entries(o),([u])=>u).map(([u,b])=>typeof b=="string"?[u,b]:[u,JSON.stringify(b)])},[t.credentialData]);return I($,{children:[p&&Object.keys(t).length!==0&&e(Ns,{credentialData:f,onClose:()=>{c()}}),e(M,{children:i}),e(M,{children:e(N,{className:"kc-showData-btn",variant:"link","data-testid":"showDataBtn",onClick:c,children:a("showDataBtn")})}),t.type==="password"?e(M,{isActionCell:!0,children:e(N,{variant:"secondary","data-testid":"resetPasswordBtn",onClick:s,children:a("resetPasswordBtn")})}):e(M,{}),e(M,{isActionCell:!0,children:e(xt,{isPlain:!0,position:St.right,toggle:e(Lt,{onToggle:l}),isOpen:d,dropdownItems:[e(Fe,{"data-testid":"deleteDropdownItem",component:"button",onClick:()=>{n(),l()},children:a("deleteBtn")},t.id)]})})]})};const Ms=({user:t,onSetPassword:s})=>{const{t:n}=E("users"),{adminClient:i}=K(),[a,p]=y.exports.useState();return xe(()=>i.users.getUserStorageCredentialTypes({id:t.id}),p,[]),a?e(oe,{variant:Ue.light,children:I(tt,{variant:"compact",children:[e(st,{children:I(he,{children:[e(Y,{children:n("type")}),e(Y,{children:n("providedBy")}),e(Y,{})]})}),e(rt,{children:a.map(c=>I(he,{children:[e(M,{children:e("b",{children:c})}),e(M,{children:e(ds,{user:t})}),c==="password"&&e(M,{modifier:"fitContent",children:e(N,{variant:"secondary",onClick:s,children:n("setPassword")})})]},c))})]})}):e(Je,{})},Ks=({user:t})=>{const{t:s}=E("users"),{addAlert:n,addError:i}=J(),[a,p]=y.exports.useState(0),c=()=>p(a+1),[d,l]=y.exports.useState(!1),[m,f]=y.exports.useState(!1),{adminClient:o}=K(),[u,b]=y.exports.useState([]),[g,R]=y.exports.useState([]),[k,B]=y.exports.useState({}),[Z,ee]=y.exports.useState(!1),[L,W]=y.exports.useState(),D=y.exports.useRef(null),[A,G]=y.exports.useState({draggedItemId:"",draggingToItemIndex:-1,dragging:!1,tempItemOrder:[""]});xe(()=>o.users.getCredentials({id:t.id}),r=>{b(r);const C=r.reduce((T,x)=>(T[x.type]=T[x.type]||[],T[x.type].push(x),T),Object.create(null)),w=Object.keys(C).map(T=>({key:T,value:C[T]}));R(w.map(T=>({...T,isExpanded:!1})))},[a]);const S=u.find(r=>r.type==="password"),h=()=>l(!d),F=()=>{f(!m)},ue=()=>{ee(!0),h()},[Ae,Re]=ie({titleKey:s("deleteCredentialsConfirmTitle"),messageKey:s("deleteCredentialsConfirm"),continueButtonLabel:s("common:delete"),continueButtonVariant:ne.danger,onConfirm:async()=>{try{await o.users.deleteCredential({id:t.id,credentialId:k.id}),n(s("deleteCredentialsSuccess"),V.success),p(r=>r+1)}catch(r){i("users:deleteCredentialsError",r)}}}),v=({credential:r})=>e(Us,{credential:r,toggleDelete:()=>{B(r),Ae()},resetPassword:ue,children:e(Fs,{credential:r,userId:t.id,isEditable:L?.status&&L.rowKey===r.id||!1,toggle:()=>{W({status:!L?.status,rowKey:r.id}),L?.status&&c()}})},r.id),j=y.exports.useMemo(()=>g.flatMap(r=>[r.value.map(({id:C})=>C).toString(),...r.isExpanded?r.value.map(C=>C.id):[]]),[g]),se=r=>{r.dataTransfer.effectAllowed="move",r.dataTransfer.setData("text/plain",r.currentTarget.id);const C=r.currentTarget.id;r.currentTarget.classList.add(Ee.modifiers.ghostRow),r.currentTarget.setAttribute("aria-pressed","true"),G({...A,draggedItemId:C,dragging:!0})},de=(r,C,w)=>{const T=r.indexOf(C);if(T===w)return r;const x=[...r];return x.splice(w,0,x.splice(T,1)[0]),x},le=r=>{if(!D.current)return;const C=D.current,w=Array.from(C.children);w.every(({id:T},x)=>T===r[x])||(C.replaceChildren(),r.forEach(T=>{C.appendChild(w.find(({id:x})=>x===T))}))},ge=()=>{!D.current||(Array.from(D.current.children).forEach(r=>{r.classList.remove(Ee.modifiers.ghostRow),r.setAttribute("aria-pressed","false")}),G({...A,draggedItemId:"",draggingToItemIndex:-1,dragging:!1}))},be=r=>{ye(r)||(le(j),G({...A,draggingToItemIndex:-1}))},ye=r=>{if(!D.current)return!1;const C=D.current.getBoundingClientRect();return r.clientX>C.x&&r.clientX<C.x+C.width&&r.clientY>C.y&&r.clientY<C.y+C.height},Ce=r=>{ye(r)?we(A.draggedItemId,A.tempItemOrder):ge()},me=r=>{r.preventDefault();const w=r.target.closest("tr");if(!(!w||D.current&&!D.current.contains(w)||w.id===A.draggedItemId)){const T=w.id,x=Array.from(D.current?.children||[]).findIndex(U=>U.id===T);if(x===A.draggingToItemIndex)return;const Q=de(j,A.draggedItemId,x);le(Q),G({...A,draggingToItemIndex:x,tempItemOrder:Q})}},pe=({target:r})=>{r instanceof HTMLTableRowElement&&(r.classList.remove(Ee.modifiers.ghostRow),r.setAttribute("aria-pressed","false"),G({...A,draggedItemId:"",draggingToItemIndex:-1,dragging:!1}))},we=async(r,C)=>{const w=j.findIndex(U=>U===r),T=C.findIndex(U=>U===r),x=T-w,Q=r.split(",");try{for(const U of Q)for(let ve=0;ve<Math.abs(x);ve++)x>0?await o.users.moveCredentialPositionDown({id:t.id,credentialId:U,newPreviousCredentialId:j[T]}):await o.users.moveCredentialPositionUp({id:t.id,credentialId:U});c(),n(s("users:updatedCredentialMoveSuccess"),V.success)}catch(U){i("users:updatedCredentialMoveError",U)}};return I($,{children:[d&&e(Ds,{user:t,isResetPassword:Z,refresh:c,onClose:()=>l(!1)}),m&&e(Es,{userId:t.id,onClose:()=>f(!1)}),e(Re,{}),u.length!==0&&S===void 0&&I($,{children:[e(N,{className:"kc-setPasswordBtn-tbl","data-testid":"setPasswordBtn-table",variant:"primary",form:"userCredentials-form",onClick:()=>{l(!0)},children:s("setPassword")}),e(Dt,{})]}),g.length!==0&&I($,{children:[t.email&&e(N,{className:"kc-resetCredentialBtn-header",variant:"primary","data-testid":"credentialResetBtn",onClick:()=>f(!0),children:s("credentialResetBtn")}),e(oe,{variant:Ue.light,children:I(tt,{variant:"compact",children:[e(st,{children:I(he,{className:"kc-table-header",children:[e(Y,{children:e(Le,{helpText:"users:userCredentialsHelpText",fieldLabelId:"users:userCredentialsHelpTextLabel"})}),e(Y,{}),e(Y,{children:s("type")}),e(Y,{children:s("userLabel")}),e(Y,{children:s("data")}),e(Y,{}),e(Y,{})]})}),e(rt,{ref:D,onDragOver:me,onDrop:me,onDragLeave:be,children:g.map((r,C)=>I(y.exports.Fragment,{children:[I(he,{id:r.value.map(({id:w})=>w).toString(),draggable:g.length>1,onDrop:Ce,onDragEnd:pe,onDragStart:se,children:[e(M,{className:g.length===1?"one-row":"",draggableRow:{id:`draggable-row-${r.value.map(({id:w})=>w)}`}}),r.value.length>1?e(M,{className:"kc-expandRow-btn",expand:{rowIndex:C,isExpanded:r.isExpanded,onToggle:(w,T)=>{const x=g.map((Q,U)=>U===T?{...Q,isExpanded:!Q.isExpanded}:Q);R(x)}}}):e(M,{}),e(M,{dataLabel:`columns-${r.key}`,className:"kc-notExpandableRow-credentialType","data-testid":"credentialType",children:He(r.key)}),r.value.length<=1&&r.value.map(w=>e(v,{credential:w},w.id))]}),r.isExpanded&&r.value.map(w=>I(he,{id:w.id,draggable:!0,onDrop:Ce,onDragEnd:pe,onDragStart:se,children:[e(M,{}),e(M,{className:"kc-draggable-dropdown-type-icon",draggableRow:{id:`draggable-row-${r.value.map(({id:T})=>T)}`}}),e(M,{dataLabel:`child-columns-${w.id}`,className:"kc-expandableRow-credentialType",children:He(w.type)}),e(v,{credential:w})]},w.id))]},r.key))})]})})]}),(t.federationLink||t.origin)&&e(Ms,{user:t,onSetPassword:h}),g.length===0&&!(t.federationLink||t.origin)&&e(Be,{hasIcon:!0,message:s("noCredentials"),instructions:s("noCredentialsText"),primaryActionText:s("setPassword"),onPrimaryAction:h,secondaryActions:t.email?[{text:s("credentialResetBtn"),onClick:F,type:ne.link}]:void 0})]})},Bs=({user:t})=>{const{t:s}=E("users"),{addAlert:n,addError:i}=J(),[a,p]=y.exports.useState(0),c=()=>p(new Date().getTime()),[d,l]=y.exports.useState([]),[m,f]=y.exports.useState(""),[o,u]=y.exports.useState(!0),[b,g]=y.exports.useState([]),[R,k]=y.exports.useState(!1),{enabled:B}=At(),{hasAccess:Z}=Qe(),ee=Z("manage-users"),{adminClient:L}=K(),W=v=>Xe(v,j=>j.path?.toUpperCase()),D=async(v,j,se)=>{const de={first:v,max:j},le=se||"";le&&(de.search=le,f(le));const ge=await L.users.listGroups({...de,id:t.id}),be=await L.groups.find(),ye=ge.reduce((P,H)=>(H.path&&P.push(H.path),P),[]),Ce=[],me=[],pe=[],we=[...be];let r=[];const C=(P,H,q)=>{if(H(P,q),typeof P!="object")return q;if(Array.isArray(P))return P.forEach(X=>C(X,H,q)),q;for(const X in P)C(P[X],H,q);return q},w=C(we,(P,H)=>{P?.subGroups&&H.push(P.subGroups)},[]),T=[].concat(...w);r=[...we,...T],ye.forEach(P=>{const H=P.split("/"),q=[];H.reduce((X,ot)=>{const Oe=X+"/"+ot;return q.push(Oe),Oe},"");for(let X=1;X<q.length;X++)pe.push(q[X].substring(1))}),me.push(...pe),r.forEach(P=>{P.subGroups.length!==0&&r.push(...P.subGroups)}),r=r.filter(P=>me.includes(P.path));const x=be.filter(P=>Ce.includes(P.name)),Q=[];x.forEach(P=>Q.push(P.subGroups));const U=ge.filter(P=>!x.includes(P));g(U);const ve=r.filter((P,H,q)=>H===q.findIndex(X=>X.name===P.name));return W(o?U:ve)};y.exports.useEffect(()=>{c()},[o]);const A=v=>v.name,G=()=>{k(!R)},[S,h]=ie({titleKey:s("leaveGroup",{count:d.length,name:d[0]?.name}),messageKey:s("leaveGroupConfirmDialog",{count:d.length,groupname:d[0]?.name,username:t.username}),continueButtonLabel:"leave",continueButtonVariant:ne.danger,onConfirm:async()=>{try{await Promise.all(d.map(v=>L.users.delFromGroup({id:t.id,groupId:v.id}))),c(),n(s("removedGroupMembership"),V.success)}catch(v){i("users:removedGroupMembershipError",v)}}}),F=v=>{l(v),S()},ue=v=>(b.some(se=>se.id===v.id)||b.length===0||o)&&e(N,{"data-testid":`leave-${v.name}`,onClick:()=>F([v]),variant:"link",isDisabled:!t.access?.manageGroupMembership,children:s("leave")}),Ae=async v=>{v.forEach(async se=>{try{await L.users.addToGroup({id:t.id,groupId:se.id}),c(),n(s("addedGroupMembership"),V.success)}catch(de){i("users:addedGroupMembershipError",de)}})},Re=v=>e(ps,{group:v});return I($,{children:[e(h,{}),R&&e(ms,{id:t.id,type:"selectMany",text:{title:s("joinGroupsFor",{username:t.username}),ok:"users:join"},canBrowse:ee,onClose:()=>k(!1),onConfirm:v=>{Ae(v||[]),k(!1),c()}}),e(Pe,{loader:D,className:"keycloak_user-section_groups-table",isPaginated:!0,ariaLabelKey:"roles:roleList",searchPlaceholderKey:"groups:searchGroup",canSelectAll:!0,onSelect:v=>l(o?v:vs(v,b,"id")),isRowDisabled:v=>!o&&b.every(j=>j.id!==v.id),toolbarItem:I($,{children:[e(N,{className:"kc-join-group-button",onClick:G,"data-testid":"add-group-button",isDisabled:!t.access?.manageGroupMembership,children:s("joinGroup")}),e(hs,{label:s("directMembership"),id:"kc-direct-membership-checkbox",onChange:()=>u(!o),isChecked:o,className:"direct-membership-check"},"direct-membership-check"),e(N,{onClick:()=>F(d),"data-testid":"leave-group-button",variant:"link",isDisabled:d.length===0,children:s("leave")}),B&&e(ns,{"aria-label":"Basic popover",position:"bottom",bodyContent:e("div",{children:s("whoWillAppearPopoverText")}),children:e(N,{variant:"link",className:"kc-who-will-appear-button",icon:e(fs,{}),children:s("whoWillAppearLinkText")},"who-will-appear-button")})]}),columns:[{name:"groupMembership",displayKey:"users:groupMembership",cellRenderer:A,cellFormatters:[z()],transforms:[O(40)]},{name:"path",displayKey:"users:path",cellRenderer:Re,transforms:[O(45)]},{name:"",cellRenderer:ue,cellFormatters:[z()],transforms:[O(20)]}],emptyState:m?"":e(Be,{hasIcon:!0,message:s("noGroups"),instructions:s("noGroupsText"),primaryActionText:s("joinGroup"),onPrimaryAction:G})},a)]})},Gs=({userId:t,federatedId:s,onClose:n,onRefresh:i})=>{const{t:a}=E("users"),{adminClient:p}=K(),{addAlert:c,addError:d}=J(),{register:l,handleSubmit:m,formState:{isValid:f,errors:o}}=ce({mode:"onChange"}),u=async b=>{try{await p.users.addToFederatedIdentity({id:t,federatedIdentityId:s,federatedIdentity:b}),c(a("users:idpLinkSuccess"),V.success),n(),i()}catch(g){d("users:couldNotLinkIdP",g)}};return e(at,{variant:Ge.small,title:a("users:linkAccountTitle",{provider:fe(s)}),onClose:n,actions:[e(N,{"data-testid":"confirm",variant:"primary",type:"submit",form:"group-form",isDisabled:!f,children:a("link")},"confirm"),e(N,{"data-testid":"cancel",variant:ne.link,onClick:n,children:a("common:cancel")},"cancel")],isOpen:!0,children:I(De,{id:"group-form",onSubmit:m(u),children:[e(te,{label:a("users:identityProvider"),fieldId:"identityProvider",children:e(Te,{id:"identityProvider","data-testid":"idpNameInput",value:fe(s),isReadOnly:!0})}),e(te,{label:a("users:userID"),fieldId:"userID",helperText:a("users-help:userIdHelperText"),helperTextInvalid:a("common:required"),validated:o.userId?_.error:_.default,isRequired:!0,children:e(Te,{id:"userID","data-testid":"userIdInput",validated:o.userId?_.error:_.default,autoFocus:!0,...l("userId",{required:!0})})}),e(te,{label:a("users:username"),fieldId:"username",helperText:a("users-help:usernameHelperText"),helperTextInvalid:a("common:required"),validated:o.userName?_.error:_.default,isRequired:!0,children:e(Te,{id:"username","data-testid":"usernameInput",validated:o.userName?_.error:_.default,...l("userName",{required:!0})})})]})})},Os=({userId:t})=>{const[s,n]=y.exports.useState(0),[i,a]=y.exports.useState(""),[p,c]=y.exports.useState(!1),{adminClient:d}=K(),{realm:l}=Se(),{addAlert:m,addError:f}=J(),{t:o}=E("users"),u=()=>n(new Date().getTime()),b=Rt().identityProviders,g=async()=>{const S=await d.identityProviders.find(),h=await d.users.listFederatedIdentities({id:t});for(const F of h)F.providerId=S.find(ue=>ue.alias===F.identityProvider)?.providerId;return h},R=async()=>(await d.realms.findOne({realm:l})).identityProviders,k=async()=>g(),B=async()=>{const S=(await g()).map(h=>h.identityProvider);return(await R())?.filter(h=>!S.includes(h.alias))},[Z,ee]=ie({titleKey:o("users:unlinkAccountTitle",{provider:fe(i)}),messageKey:o("users:unlinkAccountConfirm",{provider:fe(i)}),continueButtonLabel:"users:unlink",continueButtonVariant:ne.primary,onConfirm:async()=>{try{await d.users.delFromFederatedIdentity({id:t,federatedIdentityId:i}),m(o("users:idpUnlinkSuccess"),V.success),u()}catch(S){f("common:mappingDeletedError",S)}}}),L=S=>e(Ft,{to:Nt({realm:l,providerId:S.providerId,alias:S.identityProvider,tab:"settings"}),children:fe(S.identityProvider)}),W=S=>{const h=b?.find(F=>F.id===S.identityProvider)?.groupName;return e(qe,{color:h==="Social"?"blue":"orange",children:o(h==="Social"?"users:idpType.social":"users:idpType.custom")})},D=S=>{const h=b?.find(F=>F.id===S.providerId)?.groupName;return e(qe,{color:h==="User-defined"?"orange":"blue",children:h==="User-defined"?"Custom":h==="Social"?o("users:idpType.social"):h})},A=S=>e(N,{variant:"link",onClick:()=>{a(S.identityProvider),Z()},children:o("unlinkAccount")}),G=S=>e(N,{variant:"link",onClick:()=>{a(S.alias),c(!0)},children:o("linkAccount")});return I($,{children:[p&&e(Gs,{userId:t,federatedId:i,onClose:()=>c(!1),onRefresh:u}),e(ee,{}),I(oe,{variant:"light",className:"pf-u-p-0",children:[I(_e,{title:o("linkedIdPs"),className:"kc-linked-idps",children:[e(Ie,{children:e(ke,{className:"kc-available-idps-text",children:o("linkedIdPsText")})}),e(Pe,{loader:k,isPaginated:!1,ariaLabelKey:"users:LinkedIdPs",className:"kc-linked-IdPs-table",columns:[{name:"identityProvider",displayKey:"common:name",cellFormatters:[z()],cellRenderer:L,transforms:[O(20)]},{name:"type",displayKey:"common:type",cellFormatters:[z()],cellRenderer:W,transforms:[O(10)]},{name:"userId",displayKey:"users:userID",cellFormatters:[z()],transforms:[O(30)]},{name:"userName",displayKey:"users:username",cellFormatters:[z()],transforms:[O(20)]},{name:"",cellFormatters:[z()],cellRenderer:A,transforms:[O(20)]}],emptyState:e(Ie,{className:"kc-no-providers-text",children:e(ke,{children:o("users:noProvidersLinked")})})},s)]}),I(_e,{className:"kc-available-idps",title:o("availableIdPs"),children:[e(Ie,{children:e(ke,{className:"kc-available-idps-text",children:o("availableIdPsText")})}),e(Pe,{loader:B,isPaginated:!1,ariaLabelKey:"users:LinkedIdPs",className:"kc-linked-IdPs-table",columns:[{name:"alias",displayKey:"common:name",cellFormatters:[z(),Et()],transforms:[O(20)]},{name:"type",displayKey:"common:type",cellFormatters:[z()],cellRenderer:D,transforms:[O(60)]},{name:"",cellFormatters:[z()],cellRenderer:G}],emptyState:e(Ie,{className:"kc-no-providers-text",children:e(ke,{children:o("users:noAvailableIdentityProviders")})})},s)]})]})]})},Vs=({id:t,name:s})=>{const{t:n}=E("users"),{adminClient:i}=K(),{addAlert:a,addError:p}=J();return e(gs,{name:s,id:t,type:"users",save:async d=>{try{const l=d.filter(m=>m.client===void 0).map(m=>m.role).flat();await i.users.addRealmRoleMappings({id:t,roles:l}),await Promise.all(d.filter(m=>m.client!==void 0).map(m=>i.users.addClientRoleMappings({id:t,clientUniqueId:m.client.id,roles:[m.role]}))),a(n("roleMappingUpdatedSuccess"),V.success)}catch(l){p("clients:roleMappingUpdatedError",l)}}})},js=()=>{const{adminClient:t}=K(),{id:s}=Ke(),{realm:n}=Se(),{t:i}=E("sessions");return e(oe,{variant:"light",className:"pf-u-p-0",children:e(Zt,{loader:()=>t.users.listSessions({id:s,realm:n}),hiddenColumns:["username"],emptyInstructions:i("noSessionsForUser"),logoutUser:s})})};function Jr(){const{adminClient:t}=K(),{realm:s}=Se(),{id:n}=Ke(),{t:i}=E("users"),[a,p]=y.exports.useState(),[c,d]=y.exports.useState(),[l,m]=y.exports.useState(0),f=()=>m(o=>o+1);return xe(async()=>{const[o,u,b]=await Promise.all([t.users.findOne({id:n}),t.realms.findOne({realm:s}),t.attackDetection.findOne({id:n})]);if(!o||!u||!b)throw new Error(i("common:notFound"));const g=u.bruteForceProtected,R=g&&b.disabled;return{user:o,bruteForced:{isBruteForceProtected:g,isLocked:R}}},({user:o,bruteForced:u})=>{p(o),d(u)},[l]),!a||!c?e(Je,{}):e(Hs,{user:a,bruteForced:c,refresh:f})}const Hs=({user:t,bruteForced:s,refresh:n})=>{const{t:i}=E("users"),{realm:a}=Se(),{adminClient:p}=K(),{addAlert:c,addError:d}=J(),l=Ut(),{hasAccess:m}=Qe(),f=ce({mode:"onChange",defaultValues:t}),o=h=>Kt({realm:a,id:t.id,tab:h}),u=h=>Ot(o(h)),b=u("settings"),g=u("attributes"),R=u("credentials"),k=u("role-mapping"),B=u("groups"),Z=u("consents"),ee=u("identity-provider-links"),L=u("sessions"),W=async h=>{try{await p.users.update({id:t.id},{...h,username:h.username?.trim(),attributes:{...t.attributes,...h.attributes}}),c(i("userSaved"),V.success),n()}catch(F){cs(F)?d(us(F),F):d("users:userCreateError",F)}},[D,A]=ie({titleKey:"users:deleteConfirm",messageKey:"users:deleteConfirmCurrentUser",continueButtonLabel:"common:delete",continueButtonVariant:ne.danger,onConfirm:async()=>{try{await p.users.del({id:t.id}),c(i("userDeletedSuccess"),V.success),l(Mt({realm:a}))}catch(h){d("users:userDeletedError",h)}}}),[G,S]=ie({titleKey:"users:impersonateConfirm",messageKey:"users:impersonateConfirmDialog",continueButtonLabel:"users:impersonate",onConfirm:async()=>{try{const h=await p.users.impersonation({id:t.id},{user:t.id,realm:a});h.sameRealm?window.location=h.redirect:window.open(h.redirect,"_blank")}catch(h){d("users:impersonateError",h)}}});return I($,{children:[e(S,{}),e(A,{}),e(Vt,{titleKey:t.username,className:"kc-username-view-header",divider:!1,dropdownItems:[e(Fe,{isDisabled:!t.access?.impersonate,onClick:()=>G(),children:i("impersonate")},"impersonate"),e(Fe,{isDisabled:!t.access?.manage,onClick:()=>D(),children:i("common:delete")},"delete")],onToggle:h=>W({...t,enabled:h}),isEnabled:t.enabled}),e(oe,{variant:"light",className:"pf-u-p-0",children:e(Ht,{children:e(Ze,{...f,children:I(Gt,{isBox:!0,mountOnEnter:!0,defaultLocation:o("settings"),children:[e(re,{"data-testid":"user-details-tab",title:e(ae,{children:i("common:details")}),...b,children:e(oe,{variant:"light",children:e(ls,{save:W,user:t,bruteForce:s})})}),e(re,{"data-testid":"attributes",title:e(ae,{children:i("common:attributes")}),...g,children:e(xs,{user:t})}),e(re,{"data-testid":"credentials",isHidden:!t.access?.manage,title:e(ae,{children:i("common:credentials")}),...R,children:e(Ks,{user:t})}),e(re,{"data-testid":"role-mapping-tab",isHidden:!t.access?.mapRoles,title:e(ae,{children:i("roleMapping")}),...k,children:e(Vs,{id:t.id,name:t.username})}),e(re,{"data-testid":"user-groups-tab",title:e(ae,{children:i("common:groups")}),...B,children:e(Bs,{user:t})}),e(re,{"data-testid":"user-consents-tab",title:e(ae,{children:i("consents")}),...Z,children:e(Ss,{})}),m("view-identity-providers")&&e(re,{"data-testid":"identity-provider-links-tab",title:e(ae,{children:i("identityProviderLinks")}),...ee,children:e(Os,{userId:t.id})}),e(re,{"data-testid":"user-sessions-tab",title:e(ae,{children:i("sessions")}),...L,children:e(js,{})})]})})})})]})};export{Jr as default};
//# sourceMappingURL=EditUser.04c9bbf0.js.map
