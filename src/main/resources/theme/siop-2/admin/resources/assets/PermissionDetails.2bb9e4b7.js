import{a as O}from"./policyRepresentation.f72f5f84.js";import{u as M,az as U,r as y,aZ as _,j as e,ax as $,aA as W,ad as k,aX as N,c6 as B,K as X,h as V,F as j,n as Z,ao as J,P as Q,aB as Y,q as E,b3 as ee,bS as se}from"./index.7cbfb18a.js";import{a as ie,C as G,u as te,b as oe,F as ae}from"./index.esm.1e7ace95.js";import{u as re}from"./ConfirmDialog.4dc691c5.js";import{F as ne}from"./FormAccess.3a7ea209.js";import{H as p}from"./HelpItem.719382e8.js";import{K as le}from"./KeycloakTextArea.d98120cb.js";import{K as z}from"./KeycloakTextInput.9afb01cd.js";import{V as ce}from"./ViewHeader.083cd951.js";import{u as de}from"./useParams.3f76335e.js";import{R as H}from"./ResourcesPolicySelect.b32d6a9a.js";import{S as pe,b as K,a as me}from"./Select.fbe867d5.js";import{a as m,A as ue}from"./FormGroup.60c77f60.js";import{R as fe}from"./Radio.7ee3497e.js";import"./Modal.11970fe7.js";import"./copy-icon.dbf95270.js";import"./GridItem.63e5e367.js";import"./Text.28ece842.js";import"./check.51c67984.js";import"./star-icon.a6efdd26.js";const he=({clientId:s,resourceId:u,preSelected:f})=>{const{t:S}=M("clients"),{adminClient:C}=U(),{control:d,getValues:q,setValue:F,formState:{errors:a}}=ie(),[g,r]=y.exports.useState([]),[o,T]=y.exports.useState([]),[n,b]=y.exports.useState(""),[P,I]=y.exports.useState(!1),A=y.exports.useRef(!0),D=q("scopes"),v=l=>l.map(c=>e(me,{value:c,children:c.name},c.id));return _(async()=>u?(u&&!A.current&&F("scopes",[]),A.current=!1,C.clients.listScopesByResource({id:s,resourceName:u})):C.clients.listAllScopes(Object.assign({id:s,deep:!1},n===""?null:{name:n})),l=>{r(l),n||T(l.filter(c=>D?.includes(c.id)))},[u,n]),e(G,{name:"scopes",defaultValue:f?[f]:[],control:d,rules:{validate:l=>l.length>0},render:({field:l})=>e(pe,{toggleId:"scopes",variant:K.typeaheadMulti,onToggle:I,onFilter:(c,h)=>(b(h),v(g)),onClear:()=>{l.onChange([]),b("")},selections:o.map(c=>c.name),onSelect:(c,h)=>{const x=typeof h=="string"?o.find(i=>i.name===h):h,t=o.find(i=>i.id===x.id)?o.filter(i=>i.id!==x.id):[...o,x];l.onChange(t.map(i=>i.id)),T(t),b("")},isOpen:P,"aria-labelledby":S("scopes"),validated:a.scopes?"error":"default",isDisabled:!!f,typeAheadAriaLabel:S("scopes"),children:v(g)})})};function ke(){const{t:s}=M("clients"),u=te({mode:"onChange"}),{register:f,control:S,reset:C,formState:{errors:d},handleSubmit:q}=u,F=$(),{id:a,realm:g,permissionType:r,permissionId:o,selectedId:T}=de(),{adminClient:n}=U(),{addAlert:b,addError:P}=W(),[I,A]=y.exports.useState(),[D,v]=y.exports.useState(!1);_(async()=>{if(!o)return{};const[t,i,L,w]=await Promise.all([n.clients.findOnePermission({id:a,type:r,permissionId:o}),n.clients.getAssociatedResources({id:a,permissionId:o}),n.clients.getAssociatedPolicies({id:a,permissionId:o}),n.clients.getAssociatedScopes({id:a,permissionId:o})]);if(!t)throw new Error(s("common:notFound"));return{permission:t,resources:i.map(R=>R._id),policies:L.map(R=>R.id),scopes:w.map(R=>R.id)}},({permission:t,resources:i,policies:L,scopes:w})=>{C({...t,resources:i,policies:L,scopes:w}),t&&"resourceType"in t&&v(!!t.resourceType),A({...t,resources:i,policies:L})},[]);const l=async t=>{try{if(o)await n.clients.updatePermission({id:a,type:r,permissionId:o},t);else{const i=await n.clients.createPermission({id:a,type:r},t);F(se({realm:g,id:a,permissionType:r,permissionId:i.id}))}b(s((o?"update":"create")+"PermissionSuccess"),N.success)}catch(i){P("clients:permissionSaveError",i)}},[c,h]=re({titleKey:"clients:deletePermission",messageKey:s("deletePermissionConfirm",{permission:I?.name}),continueButtonVariant:k.danger,continueButtonLabel:"clients:confirm",onConfirm:async()=>{try{await n.clients.delPermission({id:a,type:r,permissionId:o}),b(s("permissionDeletedSuccess"),N.success),F(B({realm:g,clientId:a,tab:"permissions"}))}catch(t){P("clients:permissionDeletedError",t)}}}),x=oe({control:S,name:"resources",defaultValue:[]});return I?V(j,{children:[e(h,{}),e(ce,{titleKey:o?I.name:`clients:create${Z(r)}BasedPermission`,dropdownItems:o?[e(J,{"data-testid":"delete-resource",onClick:()=>c(),children:s("common:delete")},"delete")]:void 0}),e(Q,{variant:"light",children:e(ne,{isHorizontal:!0,role:"view-clients",onSubmit:q(l),children:V(ae,{...u,children:[e(m,{label:s("common:name"),isRequired:!0,helperTextInvalid:s("common:required"),validated:d.name?"error":"default",fieldId:"name",labelIcon:e(p,{helpText:"clients-help:permissionName",fieldLabelId:"name"}),children:e(z,{id:"name",validated:d.name?"error":"default",...f("name",{required:!0})})}),e(m,{label:s("common:description"),fieldId:"description",labelIcon:e(p,{helpText:"clients-help:permissionDescription",fieldLabelId:"description"}),validated:d.description?"error":"default",helperTextInvalid:d.description?.message,children:e(le,{id:"description",validated:d.description?"error":"default",...f("description",{maxLength:{value:255,message:s("common:maxLength",{length:255})}})})}),e(m,{label:s("applyToResourceTypeFlag"),fieldId:"applyToResourceTypeFlag",labelIcon:e(p,{helpText:"clients-help:applyToResourceTypeFlag",fieldLabelId:"clients:applyToResourceTypeFlag"}),children:e(Y,{id:"applyToResourceTypeFlag",name:"applyToResourceTypeFlag",label:s("common:on"),labelOff:s("common:off"),isChecked:D,onChange:v,"aria-label":s("applyToResourceTypeFlag")})}),D?e(m,{label:s("resourceType"),fieldId:"name",labelIcon:e(p,{helpText:"clients-help:resourceType",fieldLabelId:"resourceType"}),isRequired:r==="scope",children:e(z,{id:"resourceType",...f("resourceType",{required:r==="scope"})})}):e(m,{label:s("resources"),fieldId:"resources",labelIcon:e(p,{helpText:"clients-help:permissionResources",fieldLabelId:"clients:resources"}),helperTextInvalid:s("common:required"),validated:d.resources?"error":"default",isRequired:r!=="scope",children:e(H,{name:"resources",clientId:a,permissionId:o,preSelected:r==="scope"?void 0:T,variant:r==="scope"?K.typeahead:K.typeaheadMulti,isRequired:r!=="scope"})}),r==="scope"&&e(m,{label:s("authorizationScopes"),fieldId:"scopes",labelIcon:e(p,{helpText:"clients-help:permissionScopes",fieldLabelId:"clients:scopesSelect"}),helperTextInvalid:s("common:required"),validated:d.scopes?"error":"default",isRequired:!0,children:e(he,{clientId:a,resourceId:x?.[0],preSelected:T})}),e(m,{label:s("policies"),fieldId:"policies",labelIcon:e(p,{helpText:"clients-help:permissionPolicies",fieldLabelId:"clients:policies"}),children:e(H,{name:"policies",clientId:a,permissionId:o})}),e(m,{label:s("decisionStrategy"),labelIcon:e(p,{helpText:"clients-help:permissionDecisionStrategy",fieldLabelId:"clients:decisionStrategy"}),fieldId:"policyEnforcementMode",hasNoPaddingTop:!0,children:e(G,{name:"decisionStrategy","data-testid":"decisionStrategy",defaultValue:O.UNANIMOUS,control:S,render:({field:t})=>e(j,{children:Object.values(O).map(i=>e(fe,{id:i,"data-testid":i,isChecked:t.value===i,name:"decisionStrategies",onChange:()=>t.onChange(i),label:s(`decisionStrategies.${i}`),className:"pf-u-mb-md"},i))})})}),e(ue,{children:V("div",{className:"pf-u-mt-md",children:[e(E,{variant:k.primary,type:"submit","data-testid":"save",children:s("common:save")}),e(E,{variant:"link","data-testid":"cancel",component:t=>e(ee,{...t,to:B({realm:g,clientId:a,tab:"permissions"})}),children:s("common:cancel")})]})})]})})})]}):e(X,{})}export{ke as default};
//# sourceMappingURL=PermissionDetails.2bb9e4b7.js.map
